要件定義 素案 v0.1（回答反映）

1. 目的

    学生が科目ごとの評価内訳を入力し、落単判定・危険度・将来予測を可視化して自己管理に利用する。

2. 想定ユーザーとロール

    ロールは学校運用を最終形とする。MVPは単独利用で開始する。

- 学生：科目の成績データを入力し、現在値・予測・警告を閲覧する

- 教員：科目テンプレートを作成し、評価構造・重み・入力方式・閾値を設定する（最終形）

- 管理者：ユーザー管理、権限管理、年度設定、バックアップ管理（最終形）

注意（矛盾の整理）

- A1は「学校全体」、A2は「MVPは自分だけ」、A5は「学校運用レベルの個人情報」になっているため、段階導入として定義する。
    - フェーズ0（開発・MVP）：単独利用、クラウドログインあり
    - フェーズ1（パイロット）：複数学生＋教員ロール
    - フェーズ2（学校運用）：個人情報・学籍・クラス管理

3. 期間モデル（学期・年度）

- 年度は前期/後期で区分する
- 科目は年度ごとにテンプレートから複製して作成する
- 必修/選択属性を科目に持たせる
- 得点は全科目で100点換算（内部表現も100点換算）

4. 評価構造（ネストと重み）

    評価はツリー構造（任意の深さ）を持つ。
    例：全体(100) → レポート(30) → 事実の正確さ(25), 出典(25)


用語定義

- 評価ノード：評価項目。子ノードを持てる（中間ノード）／持たない（葉ノード）
- 重み：親ノードに対する割合（%）
- 正規化：同一親配下の重み合計が100でない場合に内部計算用に自動正規化する

制約

- 葉ノードのみが入力対象になれる
- 中間ノードは集計値として計算する

5. 入力仕様（学生）
    各葉ノードは管理者が入力方式を指定する。学生は指定された方式で入力する。
    入力方式（葉ノード単位）
- 点数入力：earned と max（例 34/50）
- 割合入力：rate（例 68%）
- 出席入力：attended と total（例 10/12）
    補正入力（葉ノード単位）
- adjustment：加点/減点（点数換算、正負を許容）
    未実施・未入力の扱い
- 現在値（進捗ベース）：未実施ノードを除外して算出
- 最終見込み（最終成績ベース）：未実施ノードを0扱いで算出
- 両方を画面に表示する

6. 計算仕様（集計・現在値・見込み・必要点）
    6.1 葉ノードのスコア（0〜1）
- 点数入力：base = clamp(earned / max, 0..1)
- 割合入力：base = clamp(rate / 100, 0..1)
- 出席入力：base = clamp(attended / total, 0..1)
- 補正：adjustment を 100点換算の点として扱い、base に加える
    - adjustedScore100 = base*100 + adjustment
    - leafScore = clamp(adjustedScore100 / 100, 0..1)

6.2 中間ノードの集計（重み付き平均）

- 子集合C、各子の重みw_i（正規化後、合計=1）
- nodeScore = Σ (w_i * childScore_i)

6.3 科目総合点（0〜100）

- totalScore100 = rootScore * 100
- 現在値：未実施除外版で rootScore を計算
- 最終見込み：未実施0扱い版で rootScore を計算

6.4 危険度（MVP）

- 危険度 = max(0, 60 - 最終見込み総合点) もしくは max(0, 60 - 現在値総合点)
    - MVPは不足点数を基本指標として表示する
    - どちらの不足点数を使うかは表示上は両方出して良い（現在不足・見込み不足）

6.5 確定落単（必要）

- 残り未実施を満点としても60点に届かない場合、確定落単フラグを立てる
    - 判定は「未実施を1扱い」に置き換えた上限スコア upperBound を計算し、upperBound*100 < 60 で確定落単

7. 判定ロジック（イベント）
    最終形：任意のイベントを閾値に紐づけて発火条件を作れる。
    MVP：全体獲得率60%以下で落単のみ実装。再試・欠席・科目個別イベントは後段。
イベント定義（最終形のデータモデル）

- 対象：評価ノード（全体/科目/任意ノード）
- 条件：score100 が閾値を下回る、出席率が閾値を下回る、欠席回数が閾値を超える 等
- アクション：通知、フラグ付与（再試）、ステータス変更（落単確定）等

フェーズ対応

- MVP：全体（root）に対する落単閾値60のみ
- 次段：再試フラグ（テスト50未満）・欠席条件（1/3欠席）などを追加

8. 画面要件(フロントエンド)
    必須画面（要件）
- ダッシュボード：全科目の状態を俯瞰（危険度、確定落単、入力未完了数）
- 科目一覧：危険度ランキング、フィルタ（前期/後期、必修/選択）
- 科目詳細：
    - 評価ツリー表示（階層）
    - 葉ノードの入力フォーム
    - 現在値・見込み・上限・不足点数・確定落単フラグ
    - グラフ表示（積み上げ棒、円、時系列、レーダーはフェーズ分け）
- 管理者（MVP）：科目テンプレ作成、評価ツリー編集、重み設定、入力方式設定
- 管理者（MVPの最小）：全体落単閾値（60）の設定
- 管理者（次段）：イベント/閾値設定UI

入力運用（回答反映）

- 日次の通知をトリガに入力する導線を用意する    
- 入力漏れは未入力として保持し、後から一括入力できる

9. データ管理・認証・権限
- 認証：クラウドログイン必須（MVPから）
- 権限：ロール分離（学生/教員/管理者）
- エクスポート：CSV（科目別、期間別）
- バックアップ：できれば（自動バックアップはフェーズ1以降で実装）

10. データモデル素案（Django）

    主要エンティティ（最小）

- User（ロール、学校識別、将来は学籍情報）
- AcademicYear（年度、前期/後期）
- CourseTemplate（科目テンプレ、必修/選択、学期区分）
- Course（年度に属する科目インスタンス）
- EvalNode（course に紐づくツリー。parent_id、name、weight、input_type、is_leaf）
- EvalEntry（学生×葉ノード×時点の入力。earned/max、rate、attended/total、adjustment、status: 未入力/入力済）
- Threshold（MVPは course.root の60%のみでも可）
- NotificationSchedule（次段。日次通知の設定）
- AuditLog（次段。管理操作ログ）

11. API素案（Django REST想定）

- 認証：/auth/login, /auth/me
- 科目：GET /courses, GET /courses/{id}
- 評価ツリー：GET /courses/{id}/nodes, PUT /courses/{id}/nodes（管理者）
- 入力：POST /courses/{id}/entries（学生）、GET /courses/{id}/entries
- 集計：GET /courses/{id}/summary（現在値/見込み/上限/不足/確定落単）
- CSV：GET /export/courses.csv
- 閾値：GET/PUT /courses/{id}/threshold（MVPは全体のみ）

12. DB選定（前提に合わせた現実解）
- 本番：PostgreSQL（学校運用・権限・検索・将来拡張に無難）
- 開発：SQLite（ローカル簡便）
    「月数千円」「多少運用OK」なら、マネージドPostgresを前提にして設計してよい。
13. MVPスコープ（今回の完成条件）
    完成条件（I1）

- 1科目を作成できる（テンプレから複製でも良い）
- 評価ツリー（ネスト）を設定できる
- 葉ノードに入力できる（点数/割合/出席）
- 現在値・見込み・不足点数・確定落単が表示できる
- 落単判定は「全体獲得率60%以下」で動作する
- 科目一覧で危険度ランキングを表示する

MVPで落とすもの（明確に除外）

- 科目別イベント（再試、欠席アウト等）の汎用イベントエンジン
- 落単確率推定
- 学校運用の個人情報（学籍番号、クラス編成、教員割当）フル実装
- 高度な通知スケジューリング（日程連携）

14. 検証観点（Settlement）

- 同一ツリーで、未実施除外の現在値と未実施0扱いの見込みが同時に一貫して計算される
- 自動正規化が入っても、重み変更で結果が破綻しない
- 補正点が入っても 0〜100 を超えた場合に clamp される
- 確定落単判定が「残り満点でも無理」を正しく捉える
- CSVが再計算可能な形で出力される（入力値とツリー構造の両方が必要）
